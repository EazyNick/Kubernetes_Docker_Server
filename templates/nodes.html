<!-- 노드 관리 페이지 - 클러스터 노드의 상태와 리소스 사용률을 모니터링하는 페이지 -->
{% extends "base.html" %}
{% block title %}노드 - 컨테이너 모니터링{% endblock %}
{% block breadcrumb %}노드{% endblock %}
{% block content %}

<!-- 노드 개요 메트릭 카드 섹션 -->
<div class="metric-grid mb-4">
    <div class="metric-card">
        <div class="metric-card-header">
            <div class="metric-icon success">
                <i class="fas fa-server"></i>
            </div>
        </div>
        <div class="metric-value" id="healthyNodes">-</div>
        <div class="metric-label">정상 노드</div>
        <div class="metric-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="healthyNodesChange">-</span>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-card-header">
            <div class="metric-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>
        <div class="metric-value" id="warningNodes">-</div>
        <div class="metric-label">주의 노드</div>
        <div class="metric-change negative">
            <i class="fas fa-arrow-up"></i>
            <span id="warningNodesChange">-</span>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-card-header">
            <div class="metric-icon primary">
                <i class="fas fa-microchip"></i>
            </div>
        </div>
        <div class="metric-value" id="totalCores">-</div>
        <div class="metric-label">총 CPU 코어</div>
        <div class="metric-change">
            <i class="fas fa-minus"></i>
            <span id="totalCoresChange">-</span>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-card-header">
            <div class="metric-icon info">
                <i class="fas fa-memory"></i>
            </div>
        </div>
        <div class="metric-value" id="totalMemory">-</div>
        <div class="metric-label">총 메모리</div>
        <div class="metric-change">
            <i class="fas fa-minus"></i>
            <span id="totalMemoryChange">-</span>
        </div>
    </div>
</div>

<!-- 평균 리소스 사용률 메트릭 카드 섹션 -->
<div class="metric-grid mb-4">
    <div class="metric-card">
        <div class="metric-card-header">
            <div class="metric-icon warning">
                <i class="fas fa-microchip"></i>
            </div>
        </div>
        <div class="metric-value" id="avgCpuUsage">-</div>
        <div class="metric-label">평균 CPU 사용률</div>
        <div class="metric-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="avgCpuUsageChange">-</span>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-card-header">
            <div class="metric-icon info">
                <i class="fas fa-memory"></i>
            </div>
        </div>
        <div class="metric-value" id="avgMemoryUsage">-</div>
        <div class="metric-label">평균 메모리 사용률</div>
        <div class="metric-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="avgMemoryUsageChange">-</span>
        </div>
    </div>
</div>

<!-- 노드 목록 테이블 섹션 -->
<div class="row">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="dashboard-card-title">
                    <i class="fas fa-server"></i>
                    클러스터 노드 목록
                </div>
                <div class="dashboard-card-subtitle">모든 노드의 상세 정보 및 상태</div>
            </div>
            <div class="dashboard-card-body">
                <div class="table-container">
                    <table id="nodesTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="name">
                                    노드명 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="status">
                                    상태 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="role">
                                    역할 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="cpu">
                                    CPU <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="memory">
                                    메모리 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="disk">
                                    디스크 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="containers">
                                    컨테이너 수 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="uptime">
                                    업타임 <i class="fas fa-sort sort-icon"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="nodesTableBody">
                            <!-- 노드 데이터가 여기에 동적으로 로드됩니다 -->
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    노드 목록을 불러오는 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 노드 리소스 사용률 차트 섹션 -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="dashboard-card-title">
                    <i class="fas fa-chart-bar"></i>
                    노드별 CPU 사용률
                </div>
            </div>
            <div class="dashboard-card-body">
                <div class="chart-container chart-container-small">
                    <canvas id="nodeCpuChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="dashboard-card-title">
                    <i class="fas fa-chart-bar"></i>
                    노드별 메모리 사용률
                </div>
            </div>
            <div class="dashboard-card-body">
                <div class="chart-container chart-container-small">
                    <canvas id="nodeMemoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 정렬 기능 JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const table = document.getElementById('nodesTable');
  const headers = table.querySelectorAll('th.sortable');
  let currentSort = { column: null, direction: 'asc' };

  headers.forEach(header => {
    header.addEventListener('click', function() {
      const column = this.dataset.column;
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // 정렬 방향 결정
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.direction = 'asc';
      }
      currentSort.column = column;

      // 정렬 실행
      rows.sort((a, b) => {
        const aValue = getCellValue(a, column);
        const bValue = getCellValue(b, column);
        
        if (column === 'cpu' || column === 'memory' || column === 'disk') {
          // 숫자 정렬 (퍼센트 값) - 퍼센트 기호 제거 후 숫자로 변환
          const aNum = parseFloat(aValue.replace('%', '')) || 0;
          const bNum = parseFloat(bValue.replace('%', '')) || 0;
          return currentSort.direction === 'asc' ? aNum - bNum : bNum - aNum;
        } else if (column === 'containers') {
          // 숫자 정렬 (컨테이너 수)
          const aNum = parseInt(aValue);
          const bNum = parseInt(bValue);
          return currentSort.direction === 'asc' ? aNum - bNum : bNum - aNum;
        } else if (column === 'uptime') {
          // 업타임 정렬 (일수 기준)
          const aDays = parseUptime(aValue);
          const bDays = parseUptime(bValue);
          return currentSort.direction === 'asc' ? aDays - bDays : bDays - aDays;
        } else {
          // 문자열 정렬
          return currentSort.direction === 'asc' 
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
        }
      });

      // 테이블 업데이트
      rows.forEach(row => tbody.appendChild(row));

      // 정렬 아이콘 업데이트
      updateSortIcons();
    });
  });

  function getCellValue(row, column) {
    const cellIndex = Array.from(headers).findIndex(h => h.dataset.column === column);
    const cell = row.cells[cellIndex];
    
    if (column === 'name') {
      return cell.querySelector('strong').textContent;
    } else if (column === 'status') {
      return cell.querySelector('.status-badge').textContent;
    } else if (column === 'cpu' || column === 'memory' || column === 'disk') {
      // 퍼센트 값 추출 (예: "45%" -> "45%")
      const span = cell.querySelector('span');
      return span ? span.textContent.trim() : cell.textContent.trim();
    } else if (column === 'containers') {
      return cell.textContent.trim();
    } else {
      return cell.textContent.trim();
    }
  }

  function parseUptime(uptimeStr) {
    // "25d 12h" 형태를 일수로 변환
    const match = uptimeStr.match(/(\d+)d\s*(\d+)?h?/);
    if (match) {
      const days = parseInt(match[1]);
      const hours = match[2] ? parseInt(match[2]) : 0;
      return days + (hours / 24);
    }
    return 0;
  }

  function updateSortIcons() {
    headers.forEach(header => {
      const icon = header.querySelector('.sort-icon');
      icon.className = 'fas fa-sort sort-icon';
      
      if (header.dataset.column === currentSort.column) {
        icon.className = currentSort.direction === 'asc' 
          ? 'fas fa-sort-up sort-icon' 
          : 'fas fa-sort-down sort-icon';
      }
    });
  }
});
</script>

{% endblock %}