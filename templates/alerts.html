<!-- 알림 관리 페이지 - 시스템 알림 및 경고를 모니터링하고 관리하는 페이지 -->
{% extends "base.html" %}
{% block title %}알림 - 컨테이너 모니터링{% endblock %}
{% block breadcrumb %}알림{% endblock %}
{% block content %}

<!-- 알림 통계 메트릭 카드 섹션 -->
<div class="metric-grid mb-4">
    <div class="metric-card">
      <div class="metric-card-header">
        <div class="metric-icon danger">
          <i class="fas fa-exclamation-circle"></i>
        </div>
      </div>
        <div class="metric-value" id="criticalAlerts">-</div>
        <div class="metric-label">Critical 알림</div>
      <div class="metric-change negative">
        <i class="fas fa-arrow-up"></i>
            <span id="criticalAlertsChange">-</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-card-header">
        <div class="metric-icon warning">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
        <div class="metric-value" id="warningAlerts">-</div>
        <div class="metric-label">Warning 알림</div>
      <div class="metric-change positive">
        <i class="fas fa-arrow-down"></i>
            <span id="warningAlertsChange">-</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-card-header">
        <div class="metric-icon info">
          <i class="fas fa-info-circle"></i>
        </div>
      </div>
        <div class="metric-value" id="infoAlerts">-</div>
        <div class="metric-label">Info 알림</div>
        <div class="metric-change">
            <i class="fas fa-minus"></i>
            <span id="infoAlertsChange">-</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-card-header">
        <div class="metric-icon success">
          <i class="fas fa-check-circle"></i>
        </div>
      </div>
        <div class="metric-value" id="resolvedAlerts">-</div>
      <div class="metric-label">해결된 알림</div>
      <div class="metric-change positive">
        <i class="fas fa-arrow-up"></i>
            <span id="resolvedAlertsChange">-</span>
    </div>
  </div>
</div>

<!-- 활성 알림 섹션 -->
<div class="row mb-4">
    <div class="col-12">
<div class="dashboard-card">
  <div class="dashboard-card-header">
                <div class="dashboard-card-title">
      <i class="fas fa-bell"></i>
                    활성 알림
                </div>
                <div class="dashboard-card-subtitle">현재 처리가 필요한 알림 목록</div>
  </div>
  <div class="dashboard-card-body">
    <div class="table-container">
                    <table id="alertsTable" class="table table-hover">
        <thead>
          <tr>
                                <th class="sortable" data-column="status">
                                    상태 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="alert_type">
                                    알림명 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="target">
                                    대상 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="message">
                                    메시지 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="created_at">
                                    발생 시간 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable duration-column" data-column="duration">
                                    지속 시간 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th>액션</th>
          </tr>
        </thead>
        <tbody id="alertsTableBody">
                            <!-- 알림 데이터가 여기에 동적으로 로드됩니다 -->
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    알림 목록을 불러오는 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 알림 규칙 관리 및 설정 섹션 -->
<div class="row">
    <div class="col-lg-8">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="dashboard-card-title">
                    <i class="fas fa-cogs"></i>
                    알림 규칙 관리
                </div>
                <div class="dashboard-card-subtitle">자동 알림을 위한 임계값 설정</div>
            </div>
            <div class="dashboard-card-body">
                <div class="table-container">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>규칙명</th>
                                <th>대상</th>
                                <th>조건</th>
                                <th>심각도</th>
                                <th>상태</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="alertRulesTableBody">
                            <!-- 알림 규칙 데이터가 여기에 동적으로 로드됩니다 -->
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    알림 규칙을 불러오는 중...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
    </div>
    <div class="col-lg-4">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <div class="dashboard-card-title">
                    <i class="fas fa-chart-line"></i>
                    알림 발생 추이
                </div>
            </div>
            <div class="dashboard-card-body">
                <div class="chart-container chart-container-small">
                    <canvas id="alertTrendChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 알림 설정 -->
        <div class="dashboard-card mt-4">
            <div class="dashboard-card-header">
                <div class="dashboard-card-title">
                    <i class="fas fa-bell"></i>
                    알림 설정
                </div>
            </div>
            <div class="dashboard-card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label">이메일 알림</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotification" checked>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label">Slack 알림</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="slackNotification" checked>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label">SMS 알림</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="smsNotification">
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="saveSettingsBtn" onclick="handleSaveSettings()">
                    <i class="fas fa-save me-2"></i>
                    설정 저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 알림 규칙 편집 팝업 -->
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-labelledby="editRuleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editRuleModalLabel">
          <i class="fas fa-edit me-2"></i>
          알림 규칙 편집
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editRuleForm">
          <input type="hidden" id="editRuleId" name="ruleId">
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editRuleName" class="form-label">규칙명 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editRuleName" name="name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editRuleTarget" class="form-label">대상 <span class="text-danger">*</span></label>
                <select class="form-select" id="editRuleTarget" name="target" required>
                  <option value="">대상을 선택하세요</option>
                  <option value="모든 노드">모든 노드</option>
                  <option value="모든 컨테이너">모든 컨테이너</option>
                  <option value="Kubernetes 클러스터">Kubernetes 클러스터</option>
                  <option value="특정 네임스페이스">특정 네임스페이스</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="editRuleCondition" class="form-label">조건 <span class="text-danger">*</span></label>
            <select class="form-select" id="editRuleCondition" name="condition" required>
              <option value="">조건을 선택하세요</option>
              <option value="CPU > 85% for 5min">CPU > 85% for 5min</option>
              <option value="Memory > 90% for 3min">Memory > 90% for 3min</option>
              <option value="Restart count > 3 in 10min">Restart count > 3 in 10min</option>
              <option value="Disk usage > 80%">Disk usage > 80%</option>
              <option value="Latency > 100ms">Latency > 100ms</option>
              <option value="Pod restart > 5 in 5min">Pod restart > 5 in 5min</option>
              <option value="Node status != Ready">Node status != Ready</option>
              <option value="Service endpoints = 0">Service endpoints = 0</option>
              <option value="Disk I/O > 100MB/s">Disk I/O > 100MB/s</option>
            </select>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editRuleSeverity" class="form-label">심각도 <span class="text-danger">*</span></label>
                <select class="form-select" id="editRuleSeverity" name="severity" required>
                  <option value="">심각도를 선택하세요</option>
                  <option value="Critical">Critical</option>
                  <option value="Warning">Warning</option>
                  <option value="Info">Info</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="editRuleStatus" class="form-label">상태 <span class="text-danger">*</span></label>
                <select class="form-select" id="editRuleStatus" name="status" required>
                  <option value="">상태를 선택하세요</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                  <option value="Testing">Testing</option>
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>
          취소
        </button>
        <button type="button" class="btn btn-primary" id="saveRuleBtn" onclick="saveAlertRule()">
          <i class="fas fa-save me-2"></i>
          저장
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 알림 상세보기 팝업 -->
<div class="modal fade" id="alertDetailModal" tabindex="-1" aria-labelledby="alertDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertDetailModalLabel">
          <i class="fas fa-bell me-2"></i>
          알림 상세 정보
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- 알림 기본 정보 -->
          <div class="col-md-6">
            <div class="alert-detail-section">
              <h6 class="alert-detail-title">
                <i class="fas fa-info-circle me-2"></i>
                기본 정보
              </h6>
              <div class="alert-detail-content">
                <div class="detail-item">
                  <span class="detail-label">알림 ID:</span>
                  <span class="detail-value" id="detailAlertId">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">알림 유형:</span>
                  <span class="detail-value" id="detailAlertType">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">대상:</span>
                  <span class="detail-value" id="detailTarget">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">심각도:</span>
                  <span class="detail-value" id="detailSeverity">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">상태:</span>
                  <span class="detail-value" id="detailStatus">-</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 시간 정보 -->
          <div class="col-md-6">
            <div class="alert-detail-section">
              <h6 class="alert-detail-title">
                <i class="fas fa-clock me-2"></i>
                시간 정보
              </h6>
              <div class="alert-detail-content">
                <div class="detail-item">
                  <span class="detail-label">발생 시간:</span>
                  <span class="detail-value" id="detailCreatedAt">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">지속 시간:</span>
                  <span class="detail-value" id="detailDuration">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">마지막 업데이트:</span>
                  <span class="detail-value" id="detailUpdatedAt">-</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">해결 시간:</span>
                  <span class="detail-value" id="detailResolvedAt">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 메시지 및 설명 -->
        <div class="alert-detail-section mt-3">
          <h6 class="alert-detail-title">
            <i class="fas fa-comment-alt me-2"></i>
            메시지 및 설명
          </h6>
          <div class="alert-detail-content">
            <div class="detail-item">
              <span class="detail-label">메시지:</span>
              <div class="detail-value" id="detailMessage">-</div>
            </div>
            <div class="detail-item">
              <span class="detail-label">설명:</span>
              <div class="detail-value" id="detailDescription">-</div>
            </div>
          </div>
        </div>
        
        <!-- 추가 정보 -->
        <div class="alert-detail-section mt-3">
          <h6 class="alert-detail-title">
            <i class="fas fa-cogs me-2"></i>
            추가 정보
          </h6>
          <div class="alert-detail-content">
            <div class="detail-item">
              <span class="detail-label">소스:</span>
              <span class="detail-value" id="detailSource">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">라벨:</span>
              <div class="detail-value" id="detailLabels">-</div>
            </div>
            <div class="detail-item">
              <span class="detail-label">메트릭 값:</span>
              <span class="detail-value" id="detailMetricValue">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">임계값:</span>
              <span class="detail-value" id="detailThreshold">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">에스컬레이션 레벨:</span>
              <span class="detail-value" id="detailEscalationLevel">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">담당자:</span>
              <span class="detail-value" id="detailAssignedTo">-</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">태그:</span>
              <div class="detail-value" id="detailTags">-</div>
            </div>
          </div>
        </div>
        
        <!-- 영향받는 서비스 -->
        <div class="alert-detail-section mt-3">
          <h6 class="alert-detail-title">
            <i class="fas fa-exclamation-triangle me-2"></i>
            영향받는 서비스
          </h6>
          <div class="alert-detail-content">
            <div class="detail-item">
              <span class="detail-label">서비스 목록:</span>
              <div class="detail-value" id="detailAffectedServices">-</div>
            </div>
          </div>
        </div>
        
        <!-- 해결 노트 -->
        <div class="alert-detail-section mt-3">
          <h6 class="alert-detail-title">
            <i class="fas fa-sticky-note me-2"></i>
            해결 노트
          </h6>
          <div class="alert-detail-content">
            <div class="detail-item">
              <span class="detail-label">노트:</span>
              <div class="detail-value" id="detailResolutionNotes">-</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>
          닫기
        </button>
        <button type="button" class="btn btn-success" id="resolveAlertBtn" onclick="handleModalResolve()">
          <i class="fas fa-check me-2"></i>
          해결됨으로 표시
        </button>
        <button type="button" class="btn btn-primary" id="refreshAlertBtn">
          <i class="fas fa-sync me-2"></i>
          새로고침
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 정렬 기능 JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const table = document.getElementById('alertsTable');
  const headers = table.querySelectorAll('th.sortable');
  let currentSort = { column: null, direction: 'asc' };

  headers.forEach(header => {
    header.addEventListener('click', function() {
      const column = this.dataset.column;
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // 정렬 방향 결정
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.direction = 'asc';
      }
      currentSort.column = column;

      // 정렬 실행
      rows.sort((a, b) => {
        const aValue = getCellValue(a, column);
        const bValue = getCellValue(b, column);
        
        if (column === 'duration') {
          // 지속 시간 정렬 (분 단위)
          const aMinutes = parseDuration(aValue);
          const bMinutes = parseDuration(bValue);
          return currentSort.direction === 'asc' ? aMinutes - bMinutes : bMinutes - aMinutes;
        } else if (column === 'created_at') {
          // 날짜 정렬
          const aDate = new Date(aValue);
          const bDate = new Date(bValue);
          return currentSort.direction === 'asc' ? aDate - bDate : bDate - aDate;
        } else {
          // 문자열 정렬
          return currentSort.direction === 'asc' 
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
        }
      });

      // 테이블 업데이트
      rows.forEach(row => tbody.appendChild(row));

      // 정렬 아이콘 업데이트
      updateSortIcons();
    });
  });

  function getCellValue(row, column) {
    const cellIndex = Array.from(headers).findIndex(h => h.dataset.column === column);
    const cell = row.cells[cellIndex];
    
    if (column === 'status') {
      return cell.querySelector('.status-badge').textContent.trim();
    } else if (column === 'alert_type') {
      return cell.querySelector('strong').textContent;
    } else {
      return cell.textContent.trim();
    }
  }

  function parseDuration(durationStr) {
    // "25분" 형태를 분수로 변환
    const match = durationStr.match(/(\d+)분/);
    return match ? parseInt(match[1]) : 0;
  }

  function updateSortIcons() {
    headers.forEach(header => {
      const icon = header.querySelector('.sort-icon');
      icon.className = 'fas fa-sort sort-icon';
      
      if (header.dataset.column === currentSort.column) {
        icon.className = currentSort.direction === 'asc' 
          ? 'fas fa-sort-up sort-icon' 
          : 'fas fa-sort-down sort-icon';
      }
    });
  }
});

// 알림 규칙 데이터 로드
if (window.AlertsAPI) {
  window.AlertsAPI.loadAlertRulesData();
}

// 알림 상세보기 팝업 초기화
document.addEventListener('DOMContentLoaded', function() {
  // Bootstrap 알림 상세보기 팝업 초기화
  const alertDetailModal = document.getElementById('alertDetailModal');
  if (alertDetailModal) {
    // 알림 상세보기 팝업이 닫힐 때 이벤트 리스너 추가
    alertDetailModal.addEventListener('hidden.bs.modal', function () {
      // 알림 상세보기 팝업이 닫힐 때 본문 내용 초기화
      const modalBody = this.querySelector('.modal-body');
      if (modalBody) {
        // 기본 구조 복원 (JavaScript 함수 사용)
        if (typeof restoreModalHTML === 'function') {
          restoreModalHTML();
        }
      }
      
      // 모든 포커스 가능한 요소의 포커스 강제 해제
      const focusedElements = this.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      focusedElements.forEach(element => {
        if (element === document.activeElement) {
          element.blur();
        }
      });
      
      // 포커스를 페이지의 다른 요소로 이동 (접근성 개선)
      // 약간의 지연을 두어 알림 상세보기 팝업이 완전히 닫힌 후 실행
      setTimeout(() => {
        const tableFocusable = document.querySelector('#alertsTable button, #alertsTable [href], #alertsTable input, #alertsTable select, #alertsTable textarea, #alertsTable [tabindex]:not([tabindex="-1"])');
        if (tableFocusable) {
          tableFocusable.focus();
        } else {
          const focusableElement = document.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
          if (focusableElement) {
            focusableElement.focus();
          }
        }
      }, 100);
    });
    
    // 알림 상세보기 팝업이 열릴 때 포커스 관리
    alertDetailModal.addEventListener('shown.bs.modal', function () {
      // 알림 상세보기 팝업이 완전히 열린 후 첫 번째 포커스 가능한 요소에 포커스
      const firstFocusable = this.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (firstFocusable) {
        firstFocusable.focus();
      }
    });
  }
});
</script>

{% endblock %}
